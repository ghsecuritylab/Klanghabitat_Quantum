/*********************************************************************
*                                                                    *
*                SEGGER Microcontroller GmbH & Co. KG                *
*        Solutions for real time microcontroller applications        *
*                                                                    *
**********************************************************************
*                                                                    *
* C-file generated by:                                               *
*                                                                    *
*        GUI_Builder for emWin version 5.40                          *
*        Compiled Jun 22 2017, 10:13:26                              *
*        (c) 2017 Segger Microcontroller GmbH & Co. KG               *
*                                                                    *
**********************************************************************
*                                                                    *
*        Internet: www.segger.com  Support: support@segger.com       *
*                                                                    *
**********************************************************************
*/

// USER START (Optionally insert additional includes)
// USER END
#include "GUI_App.h"
#include "DIALOG.h"
#include "usb_device.h"
#include "math.h"
#include "main.h"
#include "settings.h"
//#include "stm32f4xx_hal.h"
/*********************************************************************
*
*       Defines
*
**********************************************************************
*/

char Value;
#define ID_WINDOW_0  (GUI_ID_USER + 0x00)


// USER START (Optionally insert additional defines)
// USER END

static void drawFloat (int pos_x, int pos_y, float val, const char * s);
void drawWaveForm();

static const GUI_WIDGET_CREATE_INFO _aDialogCreate[] = {
  { WINDOW_CreateIndirect, "Window", ID_WINDOW_0, 0, 0, 800, 480, 0, 0x0, 0 },


  // USER START (Optionally insert additional widgets)
  // USER END
};






uint32_t lineStart,lineEnd;
uint32_t avCH1;
uint32_t maxCH1;

int16_t  sampleBuffer[10];
int16_t  ringBuffer[810];
int sample = 0;
float logLevel;
int startup = 0;
uint16_t samples[250];
uint16_t samples2[250];


int X = 0;
int Y = 0;

int pots[6];
int poti[6];
int delay[6];
int pox[6]={10,10,10,550,550,550};
int poy[6]={220,400,40,400,40,220};
const char *units[6] = {"ms","sec","dB","dBu","ms","ms"};


begin = 0;
/*********************************************************************
*
*       Static code
*
**********************************************************************
*/
/*********************************************************************
*
*       _GetImageById
*/


// USER START (Optionally insert additional static code)


// USER END

/*********************************************************************
*
*       _cbDialog
*/
static void _cbDialog(WM_MESSAGE * pMsg) {
  const void * pData;
  WM_HWIN      hItem;
  U32          FileSize;
  int          NCode;
  int          Id;
  // USER START (Optionally insert additional variables)
  // USER END


  switch (pMsg->MsgId) {
  case WM_PAINT:
	  GUI_SetBkColor(GUI_DARKGRAY);
	  GUI_Clear();
    break;
  default:
    WM_DefaultProc(pMsg);
    break;
  }

  if (begin < 5){
  	//GUI_DrawBitmap(&bmsettings, 0, 370);
  	begin = begin+1;
  }



if(X>300 && Y>100){
	  drawWaveForm();
}







/*****************DIPLAY ENCODER VALUES**************/
for(int i = 0; i<6; i++){
	 if(poti[i]!=pots[i]){
		delay[i] = 50;
	 }
	 if (delay[i]>0){
		 delay[i] --;
		 GUI_SetColor(GUI_ORANGE);
	 }
	 else {GUI_SetColor(GUI_LIGHTGRAY);}
	 poti[i] = pots[i];
	 GUI_SetFont(&GUI_FontD36x48);
	 drawFloat(pox[i],poy[i],poti[i], units[i]);
}
/*==================================================*/



	  GUI_SetColor(GUI_GRAY);


/*
USB COM
	  char *A[4];
	  char *B[4];

	  sprintf(A, "%d", adc1);
	  sprintf(B, "%d", adc2);

	  char str[11];

	  strcpy(str, "*");
	  if(adc1<10){strcat(str, "0");}
	  if(adc1<100){strcat(str, "0");}
	  if(adc1<1000){strcat(str, "0");}
	  strcat(str, A);
	  strcat(str, "-");
	  if(adc2<10){strcat(str, "0");}
	  if(adc2<100){strcat(str, "0");}
	  if(adc2<1000){strcat(str, "0");}
	  strcat(str, B);
	  strcat(str, "\r\n");

	  CDC_Transmit_FS(str, 11);

*/



}
WM_MESSAGE mess;

/*

void CDC_ReceiveCallBack(uint8_t *buf, uint32_t len){
Value = &buf;
BSP_LED_Toggle(LED1);
}
*/


void drawWaveForm(){
	for (int i = 0; i<63;i++){
		samples[i] = (DMA_TRANSFER[i] & 0x000000ffUL);
		}

	for (int i = 0; i < 63; i++)
	 {
	   if (samples[i] > maxCH1)
	   {
		   maxCH1  = samples[i];
	   }
	 }

	 for(int i=0; i<150;i++){
	    ringBuffer[i] = ringBuffer[i+1];
	    }

	 if (maxCH1<=127){
		 ringBuffer[150] = 127-maxCH1;
	 }

	 else if (maxCH1 >127){
		 ringBuffer[150] = maxCH1-127;
	 }
	maxCH1 = 0;

	GUI_SetColor( GUI_ORANGE );

		for(int i=0; i<150;i++){
	        	 lineStart = 240 - (4*ringBuffer[i]/2);
	        	 lineEnd = lineStart + (4*ringBuffer[i]);

	        	 GUI_DrawVLine(i+325,lineStart, lineEnd);
	     }

	/****************************************************/
}





void drawFloat (int pos_x, int pos_y, float val, const char * s){

			  GUI_GotoXY(pos_x, pos_y);
	  		  GUI_DispFloatMin(val, 2);


	  		  GUI_SetFont(&GUI_Font32B_1);
	  		  if(val < 10.0 && val >= 0) {GUI_DispStringAt(s, 150+pos_x, 20+pos_y);}
	  		  else if (val >= 10.0 || val<0){GUI_DispStringAt(s, 185+pos_x, 20+pos_y);}


	  	  }

/*********************************************************************
*
*       Public code
*
**********************************************************************
*/
/*********************************************************************
*
*       CreateWindow
*/
WM_HWIN CreateWindow(void);
WM_HWIN CreateWindow(void) {
  WM_HWIN hWin;

  hWin = GUI_CreateDialogBox(_aDialogCreate, GUI_COUNTOF(_aDialogCreate), _cbDialog, WM_HBKWIN, 0, 0);
  WM_Paint(hWin);
  return hWin;
}

// USER START (Optionally insert additional public code)


// USER END

/*************************** End of file ****************************/
